rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---- Users ----
    match /users/{uid} {
      allow read: if request.auth != null;
      allow create: if request.auth.uid == uid;
      allow update: if request.auth.uid == uid;
    }

    // ---- Usernames (uniqueness enforcement) ----
    match /usernames/{displayName} {
      allow read: if request.auth != null;
      // Batch write: usernames doc + users doc must be committed atomically.
      // getAfter verifies the users/{uid}.displayName matches this username key.
      allow write: if request.auth != null
        && request.resource.data.uid == request.auth.uid
        && getAfter(/databases/$(database)/documents/users/$(request.auth.uid)).data.displayName == displayName;
    }

    // ---- Leaderboard Scores ----
    match /puzzles/{puzzleId}/scores/{uid} {
      // Public read â€” leaderboard is visible to all
      allow read: if true;

      // Write rules (REQ-044, REQ-045, REQ-046, NFR-006):
      allow write: if
        // Must be authenticated and non-anonymous
        request.auth != null &&
        request.auth.token.firebase.sign_in_provider != 'anonymous' &&
        // Must be writing own score
        request.auth.uid == uid &&
        request.resource.data.userId == request.auth.uid &&
        // Required fields with correct types
        request.resource.data.moves is int &&
        request.resource.data.timeMs is int &&
        request.resource.data.minMoves is int &&
        // Server-side move count validation (REQ-046)
        request.resource.data.moves >= request.resource.data.minMoves &&
        // Only allow if: first score OR improvement (REQ-044, REQ-045)
        (
          !exists(/databases/$(database)/documents/puzzles/$(puzzleId)/scores/$(uid)) ||
          request.resource.data.moves < resource.data.moves ||
          (request.resource.data.moves == resource.data.moves &&
           request.resource.data.timeMs < resource.data.timeMs)
        );
    }
  }
}
