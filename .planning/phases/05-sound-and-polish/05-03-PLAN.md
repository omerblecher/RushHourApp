---
phase: 05-sound-and-polish
plan: "03"
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/components/Board/Board.tsx
  - src/components/Board/Board.module.css
  - src/components/Vehicle/Vehicle.tsx
  - src/components/Vehicle/Vehicle.module.css
autonomous: true
requirements:
  - REQ-016
  - NFR-005

must_haves:
  truths:
    - "User can Tab through vehicles to select one — focused vehicle shows a visible highlight ring"
    - "Arrow keys move the selected vehicle in its valid axis; invalid-axis presses do nothing"
    - "Escape key deselects the current vehicle"
    - "Arrow key presses call soundService.playSlide() when the move succeeds"
    - "Vehicles have aria-label, aria-selected, and role='gridcell' for screen reader accessibility"
    - "Grid container has role='grid' and aria-label for screen reader context"
    - "Arrow keys do NOT scroll the page when a vehicle is selected (e.preventDefault called)"
  artifacts:
    - path: "src/components/Board/Board.tsx"
      provides: "Board with keyboard handler and selectedVehicleId state"
      contains: "selectedVehicleId"
    - path: "src/components/Vehicle/Vehicle.tsx"
      provides: "Vehicle with tabIndex, ARIA attributes, focus/select callbacks, and focused CSS class"
      contains: "tabIndex"
    - path: "src/components/Vehicle/Vehicle.module.css"
      provides: "Focused vehicle highlight + glow style"
      contains: "focused"
  key_links:
    - from: "src/components/Board/Board.tsx"
      to: "src/components/Vehicle/Vehicle.tsx"
      via: "onSelect + isSelected props"
      pattern: "onSelect|isSelected"
    - from: "src/components/Board/Board.tsx"
      to: "src/services/soundService.ts"
      via: "soundService.playSlide() when keyboard move succeeds"
      pattern: "soundService\\.playSlide"
    - from: "src/components/Vehicle/Vehicle.tsx"
      to: "src/components/Vehicle/Vehicle.module.css"
      via: "styles.focused class on selected vehicle"
      pattern: "styles\\.focused"
---

<objective>
Add keyboard navigation to the game board: Tab selects vehicles, arrow keys move them, Escape deselects. Add ARIA labels to vehicles and the grid for screen reader accessibility.

Purpose: Completes REQ-016 (keyboard as alternative to mouse/touch) and NFR-005 (ARIA accessibility). Keyboard nav is added to Board and Vehicle without touching any other component.

Output: Updated Board.tsx (keyboard handler + selectedVehicleId state), updated Vehicle.tsx (tabIndex + ARIA + onSelect/isSelected props), updated Vehicle.module.css (focused glow style).
</objective>

<execution_context>
@C:/Users/omerb/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/omerb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-sound-and-polish/05-CONTEXT.md
@.planning/phases/05-sound-and-polish/05-RESEARCH.md
@.planning/phases/05-sound-and-polish/05-02-SUMMARY.md
@src/components/Board/Board.tsx
@src/components/Board/Board.module.css
@src/components/Vehicle/Vehicle.tsx
@src/components/Vehicle/Vehicle.module.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add keyboard handler and selectedVehicleId state to Board</name>
  <files>src/components/Board/Board.tsx, src/components/Board/Board.module.css</files>
  <action>
Update Board.tsx to add keyboard navigation. Board.tsx already accepts `isWinAnimating` prop from Plan 02. Read the current file before editing to understand the exact current state.

**Imports to add:**
```typescript
import { useState } from 'react';
import { soundService } from '../../services/soundService';
```

**State:**
```typescript
const [selectedVehicleId, setSelectedVehicleId] = useState<string | null>(null);
```

Add `move` from gameStore (already used by Vehicle via useDrag, but Board needs direct access for keyboard):
```typescript
const move = useGameStore((s) => s.move);
```

**Keyboard handler on the boardWrapper div:**
```typescript
const handleKeyDown = (e: React.KeyboardEvent<HTMLDivElement>) => {
  // No vehicle selected or board locked during win animation — ignore all
  if (!selectedVehicleId || isWinAnimating) return;

  const vehicle = state?.vehicles.find((v) => v.id === selectedVehicleId);
  if (!vehicle) return;

  if (e.key === 'Escape') {
    setSelectedVehicleId(null);
    return;
  }

  const isHorizontal = vehicle.orientation === 'horizontal';
  let dr = 0;
  let dc = 0;

  if (e.key === 'ArrowLeft' && isHorizontal) dc = -1;
  else if (e.key === 'ArrowRight' && isHorizontal) dc = 1;
  else if (e.key === 'ArrowUp' && !isHorizontal) dr = -1;
  else if (e.key === 'ArrowDown' && !isHorizontal) dr = 1;
  else return; // Invalid-axis key press — silently ignored per user decision

  // Prevent page scroll on arrow key presses when vehicle is selected
  e.preventDefault();

  const result = move(selectedVehicleId, vehicle.position.row + dr, vehicle.position.col + dc);
  if (result?.success) {
    soundService.playSlide();
  }
};
```

Note on `move` return value: Check gameStore.ts to understand what `move()` returns. If it returns a `MoveResult` with `{ success: boolean }`, use `result?.success`. If it returns void or just mutates state, check if position changed by reading state before/after. Look at the existing gameStore implementation and use whatever pattern it establishes. The important point is: only play sound when the move actually succeeded (vehicle moved to a new cell).

**Updated JSX — boardWrapper gets onKeyDown:**
```tsx
<div
  className={styles.boardWrapper}
  data-board
  style={isWinAnimating ? { pointerEvents: 'none' } : undefined}
  onKeyDown={handleKeyDown}
>
```

**Pass onSelect and isSelected to each Vehicle:**
```tsx
{state?.vehicles.map((vehicle) => (
  <Vehicle
    key={vehicle.id}
    vehicle={vehicle}
    isSelected={vehicle.id === selectedVehicleId}
    onSelect={setSelectedVehicleId}
  />
))}
```

**Board.module.css** — no changes needed (winGlow already added in Plan 02). The gridContainer ARIA role is added to JSX:
```tsx
<div
  className={styles.gridContainer}
  role="grid"
  aria-label="Rush Hour puzzle board, 6 by 6 grid"
>
```
  </action>
  <verify>
Run: `npx tsc --noEmit` — zero TypeScript errors in Board.tsx.
Manual: Tab to a vehicle in the browser, press ArrowRight or ArrowLeft — vehicle moves, slide sound plays.
Manual: Press Escape — vehicle deselects (no focus ring).
  </verify>
  <done>Board.tsx has selectedVehicleId state, handleKeyDown handler on boardWrapper, passes isSelected and onSelect props to Vehicle. Arrow keys move selected vehicle and play slide sound. Escape deselects. Invalid-axis presses are silently ignored. TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Add tabIndex, ARIA, focus ring to Vehicle</name>
  <files>src/components/Vehicle/Vehicle.tsx, src/components/Vehicle/Vehicle.module.css</files>
  <action>
Update Vehicle.tsx to accept `isSelected` and `onSelect` props, add `tabIndex={0}`, ARIA attributes, onClick/onFocus for selection, and apply the `.focused` CSS class.

Read the current Vehicle.tsx before editing — it uses a `ref` callback via `useDrag` and builds classNames from an array. The goal is to extend it minimally.

**Updated VehicleProps interface:**
```typescript
interface VehicleProps {
  vehicle: VehicleType;
  isSelected?: boolean;
  onSelect?: (id: string) => void;
}
```

**Destructure the new props:**
```typescript
export function Vehicle({ vehicle, isSelected = false, onSelect }: VehicleProps) {
```

**Add focused class to classNames array:**
```typescript
const classNames = [
  styles.vehicle,
  isHorizontal ? styles.horizontal : styles.vertical,
  isTruck ? styles.truck : styles.car,
  isTargetCar ? styles.targetCar : '',
  isDragging ? styles.dragging : '',
  isSelected ? styles.focused : '',
]
  .filter(Boolean)
  .join(' ');
```

**Updated div with accessibility attributes:**
```tsx
<div
  ref={ref}
  className={classNames}
  style={{ ...positionStyle, ...colorStyle, ...shadowStyle }}
  data-vehicle-id={id}
  data-orientation={orientation}
  data-row={row}
  data-col={col}
  tabIndex={0}
  role="gridcell"
  aria-label={`${isTargetCar ? 'Target car' : `Vehicle ${id}`}, ${orientation}, ${size === 3 ? 'truck' : 'car'}`}
  aria-selected={isSelected}
  onClick={() => onSelect?.(id)}
  onFocus={() => onSelect?.(id)}
  title={`Vehicle ${id}`}
/>
```

ARIA notes:
- `role="gridcell"` is appropriate for elements within a `role="grid"` container (added to gridContainer in Board.tsx).
- `aria-label` describes the vehicle type and orientation for screen readers.
- `aria-selected` communicates selection state.
- `onClick` and `onFocus` both select the vehicle — clicking selects it for keyboard use; tabbing to it also selects it.

**Vehicle.module.css — add .focused class:**

Append to the existing Vehicle.module.css:
```css
/* Keyboard focus + selection highlight (user decision: highlight + subtle glow) */
.focused {
  outline: 3px solid #f5c842;
  outline-offset: 2px;
  box-shadow:
    0 3px 8px rgba(0, 0, 0, 0.4),
    0 0 12px rgba(245, 200, 66, 0.6),
    0 0 24px rgba(245, 200, 66, 0.3);
  z-index: 50;
}

/* Suppress default browser focus ring — we use our own focused ring */
.vehicle:focus {
  outline: none;
}

/* Show our custom ring only on keyboard focus via :focus-visible */
.vehicle:focus-visible:not(.focused) {
  outline: 2px solid rgba(245, 200, 66, 0.5);
  outline-offset: 2px;
}
```

Note: The `.focused` class is applied via React state (isSelected). The `:focus-visible` fallback handles the case where a vehicle gets browser focus without being "selected" via our state — showing a subtle ring without the full gold highlight.

Also verify: The existing Vehicle CSS already uses inline styles for boxShadow (via the `shadowStyle` object). The `.focused` class's box-shadow overrides via CSS specificity — the class selector `.focused` is more specific than `style` attribute only if we move it to the class. Since inline styles win over class styles in specificity, we need to handle the boxShadow for focused vehicles: the `shadowStyle` inline style is only applied to non-target-car vehicles (`isTargetCar ? {} : { boxShadow: ... }`). For the focused state, override by adding a focused inline shadow style:

```typescript
// Merge focused shadow on top if selected
const focusedShadow: React.CSSProperties = isSelected ? {
  boxShadow: `0 3px 8px rgba(0,0,0,0.4), 0 0 12px rgba(245,200,66,0.6), 0 0 24px rgba(245,200,66,0.3), inset 0 1px 0 rgba(255,255,255,0.35), 0 0 0 3px #f5c842`,
  zIndex: 50,
} : {};
```

Then merge in the div style:
```tsx
style={{ ...positionStyle, ...colorStyle, ...shadowStyle, ...focusedShadow }}
```

This ensures the gold focus ring appears on all vehicles including the target car, regardless of their base shadow styles.
  </action>
  <verify>
Run: `npx tsc --noEmit` — zero TypeScript errors in Vehicle.tsx.
Run: `npm run build` — build succeeds.
Manual: Tab to vehicles — each shows gold outline ring when focused/selected. Screen reader: focus on a vehicle announces its label (e.g., "Target car, horizontal, car").
  </verify>
  <done>Vehicle.tsx has tabIndex=0, role="gridcell", aria-label, aria-selected. Accepts isSelected and onSelect props. Gold focused ring (outline + glow) shows when isSelected=true. TypeScript and build pass with no errors.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero errors.
2. `npm run build` — build succeeds.
3. Tab key cycles through all vehicles on the game board.
4. Selected vehicle shows gold highlight + glow ring.
5. Arrow keys move the selected vehicle in its valid axis; slide sound plays on successful move.
6. Invalid axis arrow key (e.g., left arrow on a vertical vehicle) — silently ignored, no scroll.
7. Escape deselects the selected vehicle — ring disappears.
8. Screen reader announces vehicle labels on focus.
9. Board locked during win animation — keyboard moves also disabled (isWinAnimating guard in handleKeyDown).
</verification>

<success_criteria>
- Tab cycles through vehicles, each receiving focus ring and being set as selectedVehicleId in Board
- ArrowLeft/Right move horizontal vehicles; ArrowUp/Down move vertical vehicles; other axis ignored
- Arrow keys call e.preventDefault() to prevent page scroll when vehicle is selected
- Escape clears selectedVehicleId
- Successful keyboard move calls soundService.playSlide()
- Each Vehicle has tabIndex=0, role="gridcell", aria-label with vehicle description, aria-selected
- gridContainer has role="grid" and aria-label
- `npm run build` succeeds with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-sound-and-polish/05-03-SUMMARY.md`
</output>
