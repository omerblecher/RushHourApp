---
phase: 01-game-engine
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/engine/types.ts
  - src/engine/board.ts
  - src/engine/__tests__/board.test.ts
  - tsconfig.json
  - package.json
  - vitest.config.ts
autonomous: true

must_haves:
  truths:
    - "A 36-character grid string can be parsed into a list of uniquely-identified vehicles with position, size, and orientation"
    - "The target car is always vehicle ID 'X', horizontal, on row index 2"
    - "An occupancy grid correctly maps each cell to its occupying vehicle or empty"
    - "Invalid grid strings (wrong length, overlapping IDs used inconsistently) are rejected with clear errors"
  artifacts:
    - path: "src/engine/types.ts"
      provides: "Vehicle, Orientation, Position, GridCell, PuzzleDefinition type definitions"
      exports: ["Vehicle", "Orientation", "Position", "MoveResult", "GameState", "PuzzleDefinition"]
    - path: "src/engine/board.ts"
      provides: "Grid string parser, vehicle extractor, occupancy grid builder"
      exports: ["parseGridString", "buildOccupancyGrid", "vehicleCells"]
    - path: "src/engine/__tests__/board.test.ts"
      provides: "Unit tests for grid parsing and board model"
      min_lines: 80
  key_links:
    - from: "src/engine/board.ts"
      to: "src/engine/types.ts"
      via: "imports Vehicle, Orientation, Position types"
      pattern: "import.*from.*types"
---

<objective>
Establish the foundation types and grid parsing for the Rush Hour game engine, with project scaffolding.

Purpose: Every other engine component depends on the type system and the ability to parse grid strings into structured vehicle data. This plan also bootstraps the TypeScript + Vitest project so subsequent plans can focus purely on logic.

Output: Working grid parser with comprehensive tests, all core type definitions, project configured for TypeScript + Vitest.
</objective>

<execution_context>
@C:/Users/omerb/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/omerb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-game-engine/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project scaffolding and core type definitions</name>
  <files>package.json, tsconfig.json, vitest.config.ts, src/engine/types.ts, src/engine/index.ts</files>
  <action>
Initialize the project with `npm init -y`, then install dev dependencies: `typescript`, `vitest` (for testing). Configure tsconfig.json with strict mode, ES2020 target, module NodeNext, outDir dist/, rootDir src/, and paths alias `@engine/*` -> `src/engine/*`. Configure vitest.config.ts with the same path aliases.

Create `src/engine/types.ts` with these type definitions (per user decisions):

- `Orientation`: `'horizontal' | 'vertical'`
- `Position`: `{ row: number; col: number }` (0-indexed, row 0 = top)
- `Vehicle`: `{ id: string; position: Position; size: 2 | 3; orientation: Orientation }` where id is the character from the grid string (e.g., 'A', 'X', 'O')
- `MoveResult`: `{ success: boolean; state: GameState; reason?: string }` (per user decision: invalid moves return result object with optional reason)
- `GameState`: `{ vehicles: Vehicle[]; moveCount: number; moveHistory: MoveEntry[]; startTime: number | null; endTime: number | null; isWon: boolean }` (per user decision: timer records startTime on first move, endTime on win; moveCount does NOT decrement on undo)
- `MoveEntry`: `{ vehicleId: string; fromCol: number; fromRow: number; toCol: number; toRow: number }` (per user decision: engine records start and end position only)
- `PuzzleDefinition`: `{ id: string; gridString: string; difficulty: 'beginner' | 'intermediate' | 'advanced' | 'expert'; minMoves: number; name?: string }`

Create `src/engine/index.ts` as barrel export (empty for now, will be filled as modules are built).

IMPORTANT: Zero React or Firebase dependencies. This is a pure TypeScript engine (NFR-004).
  </action>
  <verify>
`npx tsc --noEmit` compiles without errors. `npx vitest run` executes (0 tests, no failures). Confirm package.json has NO react/firebase deps.
  </verify>
  <done>TypeScript project compiles cleanly, Vitest runs, all core types are defined and exported, no UI framework dependencies present.</done>
</task>

<task type="auto">
  <name>Task 2: Grid string parser and board model with TDD</name>
  <files>src/engine/board.ts, src/engine/__tests__/board.test.ts, src/engine/index.ts</files>
  <action>
TDD: Write tests FIRST in `src/engine/__tests__/board.test.ts`, then implement in `src/engine/board.ts`.

**RED phase -- write failing tests for:**

1. `parseGridString(gridString)` -> `Vehicle[]`:
   - Test with known puzzle `"AA.O..B..OXXB..O..CPPP.CDDEEL.FFG.L"`:
     - Returns array of vehicles with correct ids: A, O, B, X, C, P, D, E, F, G, L
     - Vehicle X is horizontal, size 2, at row 2 col 1
     - Vehicle P is horizontal, size 3
     - Vehicle O is vertical, size 3
   - Test that `.` cells produce no vehicle
   - Test rejection of invalid strings: wrong length (not 36), empty string
   - Test single-vehicle puzzle: `"XX.................................."` -> 1 vehicle

2. `buildOccupancyGrid(vehicles)` -> `(string | null)[][]` (6x6 grid):
   - Test that each cell contains vehicle id or null
   - Test with parsed vehicles from the known puzzle above
   - Verify cell [2][1] = 'X', cell [2][2] = 'X' (target car position)

3. `vehicleCells(vehicle)` -> `Position[]`:
   - Test horizontal car size 2 at (0,0) -> [{row:0,col:0}, {row:0,col:1}]
   - Test vertical truck size 3 at (1,3) -> [{row:1,col:3}, {row:2,col:3}, {row:3,col:3}]

**GREEN phase -- implement:**

`parseGridString`: Iterate the 36-char string as a 6x6 grid (index / 6 = row, index % 6 = col). Collect unique non-'.' characters. For each unique char, find all positions, determine orientation (same row = horizontal, same col = vertical), compute top-left position and size. Validate: string must be exactly 36 chars. Throw on invalid input.

`buildOccupancyGrid`: Create 6x6 null grid, fill with vehicle ids using `vehicleCells`.

`vehicleCells`: Given a vehicle, return array of positions it occupies based on position, size, orientation.

Export all three functions from board.ts. Add board.ts exports to `src/engine/index.ts`.

Grid string format per user decision: `"AA.O..B..OXXB..O..CPPP.CDDEEL.FFG.L"` -- standard Rush Hour encoding. Target car always identified by 'X'.
  </action>
  <verify>
`npx vitest run` -- all board tests pass. `npx tsc --noEmit` compiles cleanly. Test count should be 10+ covering parse, occupancy, vehicleCells, and error cases.
  </verify>
  <done>Grid string parser correctly extracts vehicles with position/size/orientation from 36-char strings. Occupancy grid maps cells to vehicle IDs. Invalid inputs rejected. All tests green.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `npx vitest run` passes with 10+ tests, all green
- `src/engine/types.ts` exports Vehicle, GameState, MoveResult, PuzzleDefinition types
- `src/engine/board.ts` exports parseGridString, buildOccupancyGrid, vehicleCells
- No react, firebase, or UI dependencies in package.json
- Grid string `"AA.O..B..OXXB..O..CPPP.CDDEEL.FFG.L"` parses correctly with X at row 2
</verification>

<success_criteria>
- Project scaffolded with TypeScript + Vitest, zero UI dependencies
- All core game types defined (Vehicle, GameState, MoveResult, PuzzleDefinition, MoveEntry)
- Grid parser handles standard Rush Hour 36-char strings and rejects invalid input
- Occupancy grid correctly maps cells to vehicles
- 10+ unit tests all passing
</success_criteria>

<output>
After completion, create `.planning/phases/01-game-engine/01-01-SUMMARY.md`
</output>
