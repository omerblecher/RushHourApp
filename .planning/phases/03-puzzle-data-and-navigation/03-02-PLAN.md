---
phase: 03-puzzle-data-and-navigation
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/main.tsx
  - src/App.tsx
  - src/App.module.css
  - vite.config.ts
  - src/screens/MainMenuScreen/MainMenuScreen.tsx
  - src/screens/MainMenuScreen/MainMenuScreen.module.css
  - src/screens/PuzzleSelectScreen/PuzzleSelectScreen.tsx
  - src/screens/PuzzleSelectScreen/PuzzleSelectScreen.module.css
  - src/screens/PuzzleSelectScreen/DifficultyTabs.tsx
  - src/screens/PuzzleSelectScreen/PuzzleGrid.tsx
  - src/screens/PuzzleSelectScreen/PuzzleTile.tsx
  - src/screens/GameScreen/GameScreen.tsx
  - src/screens/GameScreen/GameScreen.module.css
  - src/screens/GameScreen/WinModal.tsx
  - src/screens/LeaderboardScreen/LeaderboardScreen.tsx
  - src/screens/LeaderboardScreen/LeaderboardScreen.module.css
autonomous: true
requirements:
  - REQ-030
  - REQ-048
  - REQ-049
  - REQ-050
  - REQ-051
  - REQ-052
  - REQ-053

must_haves:
  truths:
    - "User can navigate from main menu to difficulty selection to puzzle grid to game board and back"
    - "Browser back button navigates through screen hierarchy naturally"
    - "Difficulty tabs (Beginner/Intermediate/Advanced/Expert) filter the puzzle grid"
    - "Puzzle tiles show checkmark overlay for completed puzzles"
    - "Game board loads the selected puzzle and plays correctly"
    - "Win modal shows completion stats (moves, time, vs optimal) with Next Puzzle and Back to Selection"
    - "Progress is recorded to localStorage on puzzle win"
    - "Leaderboard route exists as a stub page"
  artifacts:
    - path: "src/App.tsx"
      provides: "Route definitions"
      contains: "Routes"
    - path: "src/main.tsx"
      provides: "BrowserRouter wrapper"
      contains: "BrowserRouter"
    - path: "src/screens/MainMenuScreen/MainMenuScreen.tsx"
      provides: "Main menu / home screen"
      contains: "Play"
    - path: "src/screens/PuzzleSelectScreen/PuzzleSelectScreen.tsx"
      provides: "Difficulty tabs and puzzle grid"
      contains: "useSearchParams"
    - path: "src/screens/GameScreen/GameScreen.tsx"
      provides: "Game board wrapper with puzzle loading"
      contains: "useParams"
    - path: "src/screens/GameScreen/WinModal.tsx"
      provides: "Win completion modal"
      contains: "Next Puzzle"
    - path: "src/screens/LeaderboardScreen/LeaderboardScreen.tsx"
      provides: "Leaderboard stub"
      contains: "Coming soon"
  key_links:
    - from: "src/screens/GameScreen/GameScreen.tsx"
      to: "src/data/puzzleIndex.ts"
      via: "getPuzzleById import"
      pattern: "getPuzzleById"
    - from: "src/screens/GameScreen/GameScreen.tsx"
      to: "src/store/progressStore.ts"
      via: "recordCompletion on win"
      pattern: "recordCompletion"
    - from: "src/screens/PuzzleSelectScreen/PuzzleSelectScreen.tsx"
      to: "src/data/puzzleIndex.ts"
      via: "PUZZLES_BY_DIFFICULTY import"
      pattern: "PUZZLES_BY_DIFFICULTY"
    - from: "src/screens/PuzzleSelectScreen/PuzzleTile.tsx"
      to: "src/store/progressStore.ts"
      via: "isCompleted check"
      pattern: "isCompleted"
    - from: "src/main.tsx"
      to: "src/App.tsx"
      via: "BrowserRouter wrapping App"
      pattern: "BrowserRouter"
---

<objective>
Wire React Router v7, build all navigation screens, and integrate puzzle loading with progress tracking.

Purpose: Transform the Phase 2 dev harness into a fully navigable multi-screen app where users browse puzzles by difficulty, play them, and see completion stats.

Output: Working routing between 4 screens (MainMenu, PuzzleSelect, GameScreen, Leaderboard stub), win modal with stats, progress recording on win.
</objective>

<execution_context>
@C:/Users/omerb/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/omerb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-puzzle-data-and-navigation/03-01-SUMMARY.md
@.planning/phases/03-puzzle-data-and-navigation/03-CONTEXT.md
@.planning/phases/03-puzzle-data-and-navigation/03-RESEARCH.md
@src/engine/types.ts
@src/store/gameStore.ts
@src/store/progressStore.ts
@src/data/puzzleIndex.ts
@src/components/Board/Board.tsx
@src/components/GameHUD/GameHUD.tsx
@src/components/ControlBar/ControlBar.tsx
@src/App.tsx
@src/main.tsx
@src/App.module.css
@vite.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up React Router and create MainMenu + PuzzleSelect screens</name>
  <files>
    src/main.tsx
    src/App.tsx
    src/App.module.css
    vite.config.ts
    src/screens/MainMenuScreen/MainMenuScreen.tsx
    src/screens/MainMenuScreen/MainMenuScreen.module.css
    src/screens/PuzzleSelectScreen/PuzzleSelectScreen.tsx
    src/screens/PuzzleSelectScreen/PuzzleSelectScreen.module.css
    src/screens/PuzzleSelectScreen/DifficultyTabs.tsx
    src/screens/PuzzleSelectScreen/PuzzleGrid.tsx
    src/screens/PuzzleSelectScreen/PuzzleTile.tsx
    src/screens/LeaderboardScreen/LeaderboardScreen.tsx
    src/screens/LeaderboardScreen/LeaderboardScreen.module.css
  </files>
  <action>
**React Router wiring:**

1. Update `src/main.tsx`: Wrap `<App />` in `<BrowserRouter>` from `"react-router"`. Keep existing imports (createRoot, index.css).

2. Rewrite `src/App.tsx`: Remove DEV_PUZZLE, remove useEffect, remove direct Board/GameHUD/ControlBar imports. Replace with React Router `<Routes>` and `<Route>` from `"react-router"`:
   - `path="/"` → `<MainMenuScreen />`
   - `path="/puzzles"` → `<PuzzleSelectScreen />`
   - `path="/play/:difficulty/:puzzleId"` → `<GameScreen />`
   - `path="/leaderboard/:difficulty/:puzzleId"` → `<LeaderboardScreen />`
   Keep the outer `<div className={styles.app}>` wrapper for global layout. Update App.module.css as needed.

3. **IMPORTANT:** Import from `"react-router"` (NOT `"react-router-dom"`). React Router v7 merged packages.

4. Verify `vite.config.ts` supports SPA routing in dev. Vite's dev server already returns index.html for unknown routes by default (no explicit historyApiFallback needed in Vite 7.x — it's the default behavior). Confirm this works; if not, add appropriate config.

**MainMenuScreen:**

Create `src/screens/MainMenuScreen/MainMenuScreen.tsx`:
- Full-viewport centered layout
- Game title "Rush Hour" prominently displayed (large, bold)
- Subtitle text like "Slide the cars. Free the red one."
- A "Play" button that navigates to `/puzzles` via `useNavigate` from `"react-router"`
- Clean, modern styling matching the game's wood/toy aesthetic from Phase 2
- Use CSS Modules (`MainMenuScreen.module.css`)

**PuzzleSelectScreen:**

Create `src/screens/PuzzleSelectScreen/PuzzleSelectScreen.tsx`:
- Uses `useSearchParams` from `"react-router"` to read/write `?difficulty=` query param
- Default difficulty is `"beginner"` when no query param present
- Renders `<DifficultyTabs>` and `<PuzzleGrid>` components
- Has a back/home link to `/` (main menu)

Create `DifficultyTabs.tsx`:
- Horizontal tabs/segmented control: Beginner | Intermediate | Advanced | Expert
- Active tab highlighted (bold/underline/color)
- Clicking a tab calls `setSearchParams({ difficulty: tabValue })`
- Tabs do NOT create browser history entries (use `replace: true` option on setSearchParams)

Create `PuzzleGrid.tsx`:
- Receives `difficulty` string prop
- Imports `PUZZLES_BY_DIFFICULTY` from `src/data/puzzleIndex`
- Renders puzzle tiles in a CSS grid: 5 columns per row
- Responsive: possibly 4 columns on narrow screens, 5 on wider

Create `PuzzleTile.tsx`:
- Props: `puzzle: PuzzleDefinition`
- Shows puzzle number extracted from ID (e.g., "beginner-03" → "3")
- Clickable — navigates to `/play/{difficulty}/{puzzleId}`
- Imports `useProgressStore` to check `isCompleted(puzzle.id)`
- Completed tiles: checkmark overlay (CSS pseudo-element or SVG), muted/green tint
- Uncompleted tiles: bold, clean appearance
- Square tiles with consistent sizing

**LeaderboardScreen (stub):**

Create `src/screens/LeaderboardScreen/LeaderboardScreen.tsx`:
- Simple stub page showing "Leaderboard — Coming in Phase 4"
- Back button navigating to previous page (`navigate(-1)`)
- Just a placeholder for the route — full implementation in Phase 4
- Use CSS Modules for minimal styling

**Styling approach:**
- All screens use CSS Modules (`.module.css` files)
- Follow existing codebase convention: `camelCaseOnly` class names
- Maintain visual consistency with the Phase 2 board styling (dark background, warm colors)
- Simple fade/slide CSS transitions between screens if straightforward; skip if complex
  </action>
  <verify>
Run `npx tsc --noEmit` — all new files type-check. Run `npm run dev`, navigate to `http://localhost:5173/` — MainMenuScreen renders. Click "Play" — PuzzleSelectScreen shows with difficulty tabs and puzzle grid. Click difficulty tabs — grid updates. Completed puzzles (if any) show checkmarks.
  </verify>
  <done>
MainMenuScreen renders at `/` with Play button. PuzzleSelectScreen at `/puzzles` shows difficulty tabs (Beginner default) and numbered puzzle tiles in a 5-column grid. Completed tiles show checkmark overlay. LeaderboardScreen stub exists at `/leaderboard/:difficulty/:puzzleId`. Browser back button works between screens.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build GameScreen with puzzle loading, WinModal, and progress recording</name>
  <files>
    src/screens/GameScreen/GameScreen.tsx
    src/screens/GameScreen/GameScreen.module.css
    src/screens/GameScreen/WinModal.tsx
    src/components/ControlBar/ControlBar.tsx
  </files>
  <action>
**GameScreen:**

Create `src/screens/GameScreen/GameScreen.tsx`:
- Uses `useParams<{ difficulty: string; puzzleId: string }>()` from `"react-router"` to read route params
- On mount (useEffect on puzzleId change): lookup puzzle via `getPuzzleById(puzzleId)` from puzzleIndex
- If puzzle not found: redirect to `/puzzles` via `navigate("/puzzles", { replace: true })`
- If found: call `loadPuzzle(puzzle.gridString, puzzle.minMoves)` on gameStore
- Renders existing `<Board />`, `<GameHUD />`, `<ControlBar />`
- Track current puzzleId in local state for WinModal's "Next Puzzle" feature
- Watch `state.isWon` — when true, show `<WinModal>`
- Record progress on win: call `recordCompletion(puzzleId, state.moveCount, timeMs)` from progressStore where `timeMs = state.endTime - state.startTime`

**WinModal:**

Create `src/screens/GameScreen/WinModal.tsx`:
- Overlay modal that appears when puzzle is won
- Shows completion stats:
  - "Your Moves: {moveCount}"
  - "Minimum Moves: {minMoves}" (from puzzle data)
  - "Your Time: {formatted time}" (MM:SS format)
  - If moves === minMoves: show a "Perfect!" or "Optimal!" badge
- Two action buttons:
  - "Next Puzzle" — navigates to next puzzle in same difficulty via `getNextPuzzle(currentId)`. If no next puzzle, navigate back to `/puzzles`
  - "Back to Selection" — navigates to `/puzzles?difficulty={currentDifficulty}`
- Modal styling: semi-transparent backdrop, centered card, clear typography
- CSS Modules for styling (can share GameScreen.module.css or have its own)

**ControlBar update:**

Modify `src/components/ControlBar/ControlBar.tsx`:
- The "Back" button currently shows `alert("Back navigation coming in Phase 3")` per Phase 2 decision
- Replace the alert with proper navigation: `navigate(-1)` using `useNavigate` from `"react-router"`
- Import `useNavigate` from `"react-router"`
- Keep undo/reset buttons unchanged

**Win detection integration:**
In GameScreen, use a `useEffect` watching `state?.isWon`:
```typescript
useEffect(() => {
  if (state?.isWon && puzzleId && state.startTime && state.endTime) {
    const timeMs = state.endTime - state.startTime;
    recordCompletion(puzzleId, state.moveCount, timeMs);
    setShowWinModal(true);
  }
}, [state?.isWon]);
```

**Reset behavior:** When user clicks reset in ControlBar, WinModal should close (if open). When navigating to a new puzzle, WinModal should close. Use a `showWinModal` state that resets when puzzleId changes.
  </action>
  <verify>
Run `npx tsc --noEmit` — all files type-check. Run `npm run dev`, navigate to `/play/beginner/beginner-01` — game board loads with the puzzle. Solve the puzzle — WinModal appears showing moves, time, and min moves. Click "Next Puzzle" — loads beginner-02. Click "Back to Selection" — returns to puzzle select. ControlBar back button uses router navigation. Check localStorage for `rushhour_progress` key after winning a puzzle.
  </verify>
  <done>
GameScreen loads puzzles from route params, integrates existing Board/HUD/ControlBar. WinModal shows completion stats with optimal comparison. Progress recorded to localStorage on win. "Next Puzzle" and "Back to Selection" navigation works. ControlBar back button uses router history. Reset clears win state.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run dev` starts without errors
3. Navigate `/` → MainMenu → "Play" → `/puzzles` → PuzzleSelect (Beginner tab default)
4. Switch difficulty tabs — grid updates, URL query param changes, back button does NOT undo tab switches
5. Click a puzzle tile → `/play/{difficulty}/{puzzleId}` → Board loads correct puzzle
6. Solve puzzle → WinModal with stats → "Next Puzzle" loads next → "Back to Selection" returns to grid
7. ControlBar Back button navigates to previous screen
8. Refresh page on any route — SPA routing serves correctly (no 404)
9. Complete a puzzle, go back to grid — completed tile shows checkmark
10. Refresh page — checkmark persists (localStorage)
11. `/leaderboard/beginner/beginner-01` shows stub page
</verification>

<success_criteria>
- Full screen navigation flow: Main Menu → Puzzle Select → Game Board → Win Modal → back to selection
- All 4 routes work with browser back/forward
- Puzzle tiles reflect completion status from progressStore
- WinModal shows moves, time, optimal moves comparison
- Progress persists in localStorage across page refreshes
- ControlBar back button properly navigates via router
- Leaderboard stub route exists
</success_criteria>

<output>
After completion, create `.planning/phases/03-puzzle-data-and-navigation/03-02-SUMMARY.md`
</output>
