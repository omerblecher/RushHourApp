---
phase: 04-firebase-integration
plan: 04
type: execute
wave: 3
depends_on:
  - 04-02
  - 04-03
files_modified:
  - src/screens/GameScreen/GameScreen.tsx
  - src/screens/GameScreen/WinModal.tsx
  - src/screens/GameScreen/WinModal.module.css
  - src/screens/LeaderboardScreen/LeaderboardScreen.tsx
  - src/screens/LeaderboardScreen/LeaderboardScreen.module.css
  - src/screens/PuzzleSelectScreen/PuzzleSelectScreen.tsx
  - src/screens/PuzzleSelectScreen/PuzzleTile.tsx
  - src/screens/PuzzleSelectScreen/PuzzleTile.module.css
autonomous: true
requirements:
  - REQ-047

must_haves:
  truths:
    - "When a puzzle is won, submitScore is called silently in the background"
    - "WinModal shows the user's leaderboard rank (e.g. '#4 on this puzzle!') for non-anonymous users"
    - "WinModal shows 'New personal best!' callout when the user beats their previous best"
    - "WinModal has a 'View leaderboard' button that opens LeaderboardModal as an overlay"
    - "LeaderboardScreen shows the real leaderboard for the puzzle (not the 'coming in Phase 4' stub)"
    - "PuzzleSelectScreen has a leaderboard button per puzzle that opens LeaderboardModal"
  artifacts:
    - path: "src/screens/GameScreen/GameScreen.tsx"
      provides: "submitScore call on win + rank state + pass rank to WinModal"
      contains: "submitScore"
    - path: "src/screens/GameScreen/WinModal.tsx"
      provides: "Rank display, 'New personal best!' callout, 'View leaderboard' button opening LeaderboardModal"
      contains: "LeaderboardModal"
    - path: "src/screens/LeaderboardScreen/LeaderboardScreen.tsx"
      provides: "Real leaderboard implementation replacing the Phase 3 stub"
      contains: "useLeaderboard"
    - path: "src/screens/PuzzleSelectScreen/PuzzleTile.tsx"
      provides: "Leaderboard button per tile that opens LeaderboardModal"
      contains: "LeaderboardModal"
  key_links:
    - from: "src/screens/GameScreen/GameScreen.tsx"
      to: "src/services/scoreService.ts"
      via: "submitScore() called in win useEffect after recordCompletion"
      pattern: "submitScore"
    - from: "src/screens/GameScreen/WinModal.tsx"
      to: "src/components/LeaderboardModal/LeaderboardModal.tsx"
      via: "state-driven: showLeaderboard bool, rendered inside WinModal"
      pattern: "LeaderboardModal.*puzzleId"
    - from: "src/screens/PuzzleSelectScreen/PuzzleTile.tsx"
      to: "src/components/LeaderboardModal/LeaderboardModal.tsx"
      via: "small leaderboard icon button per tile; modal rendered in PuzzleSelectScreen"
      pattern: "LeaderboardModal"
---

<objective>
Wire up score submission on win, enhance WinModal with rank display and personal best callout, implement the real LeaderboardScreen, and add leaderboard access from the PuzzleSelectScreen. This plan closes the "leaderboard accessible from both puzzle completion and puzzle selection" requirement (REQ-047).

Purpose: All data infrastructure exists from plans 02-03. This plan connects it to the game screens that users actually interact with.

Output: GameScreen submits scores silently on win. WinModal shows rank + PB callout + leaderboard button. LeaderboardScreen shows real data. PuzzleSelectScreen has per-puzzle leaderboard access.
</objective>

<execution_context>
@C:/Users/omerb/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/omerb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/04-firebase-integration/04-CONTEXT.md
@.planning/phases/04-firebase-integration/04-RESEARCH.md
@src/screens/GameScreen/GameScreen.tsx
@src/screens/GameScreen/WinModal.tsx
@src/screens/LeaderboardScreen/LeaderboardScreen.tsx
@src/screens/PuzzleSelectScreen/PuzzleSelectScreen.tsx
@src/screens/PuzzleSelectScreen/PuzzleTile.tsx
@src/store/progressStore.ts
@.planning/phases/04-firebase-integration/04-02-SUMMARY.md
@.planning/phases/04-firebase-integration/04-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: GameScreen score submission + WinModal leaderboard integration</name>
  <files>
    src/screens/GameScreen/GameScreen.tsx
    src/screens/GameScreen/WinModal.tsx
    src/screens/GameScreen/WinModal.module.css
  </files>
  <action>
    MODIFY `src/screens/GameScreen/GameScreen.tsx`:

    In the win detection `useEffect` (where `recordCompletion` is called), also:
    1. Get `minMoves` from the gameStore
    2. Call `submitScore(puzzleId, state.moveCount, timeMs, minMoves)` â€” fire-and-forget (no await needed, but can use void)
    3. Compute the rank by reading from the leaderboard after a short delay â€” SIMPLER APPROACH: pass `moves`, `timeMs`, and `puzzleId` to WinModal and let WinModal compute rank via `useLeaderboard` internally (avoids complexity in GameScreen)

    Pass new props to `WinModal`: `isNewPersonalBest: boolean`. Compute it in GameScreen by comparing `state.moveCount` and `timeMs` against `progressStore.getBest(puzzleId)` BEFORE calling `recordCompletion` (since recordCompletion updates the best). Logic:
    ```typescript
    const prevBest = getBest(puzzleId);  // read before recordCompletion
    const isNewPersonalBest = !prevBest ||
      moves < prevBest.bestMoves ||
      (moves === prevBest.bestMoves && timeMs < prevBest.bestTimeMs);
    ```

    MODIFY `src/screens/GameScreen/WinModal.tsx`:

    Add new props to `WinModalProps`:
    - `isNewPersonalBest: boolean`

    Add internal state: `showLeaderboard: boolean` (default false).

    Add `useLeaderboard(puzzleId)` call inside WinModal to get entries and compute current user's rank. Get `user` from `useAuthStore()`. Compute rank:
    ```typescript
    const { entries } = useLeaderboard(puzzleId);
    const currentUid = user?.uid;
    const userRank = currentUid
      ? entries.findIndex(e => e.uid === currentUid) + 1  // 1-based; 0 if not found
      : 0;
    // userRank > 0 means user is in top 50 and we know their rank
    ```

    Add to WinModal render:
    1. If `isNewPersonalBest`: render a "New personal best!" callout (styled badge/banner above stats section)
    2. If `!user?.isAnonymous && userRank > 0`: render rank display below stats: "#N on this puzzle!" with celebratory styling (large, accented text)
    3. "View leaderboard" button below the rank display (or below stats for anonymous users, still showing the button â€” anonymous users can VIEW the leaderboard, just can't submit scores)
    4. When "View leaderboard" clicked: `setShowLeaderboard(true)`
    5. Render `{showLeaderboard && <LeaderboardModal puzzleId={puzzleId} onClose={() => setShowLeaderboard(false)} onSignInToCompete={...} />}` â€” the modal stacks on top of WinModal

    For `onSignInToCompete` in the anon gate: import `useAuthStore` and call `signInWithGoogle` from the store (the upgrade flow). Actually for the LaunchPrompt gate this is the linking flow â€” but the LeaderboardModal's `onSignInToCompete` prop should trigger the anon-to-Google upgrade (from plan 04-05). For now, pass a no-op or the Google sign-in function from authStore. The full upgrade flow is wired in plan 04-05.

    MODIFY `src/screens/GameScreen/WinModal.module.css`:
    Add styles for:
    - `.personalBestBanner`: gold/amber banner above stats (e.g., "âœ¨ New personal best!")
    - `.rankDisplay`: large centered text showing rank (e.g., font-size: 1.5rem, accent color)
    - `.viewLeaderboardButton`: secondary button style
  </action>
  <verify>
    `npm run typecheck` passes.
    Inspect GameScreen.tsx: `submitScore` is called in win useEffect. `isNewPersonalBest` computed before `recordCompletion`.
    Inspect WinModal.tsx: imports `LeaderboardModal`, has `showLeaderboard` state, has `isNewPersonalBest` prop rendering the banner.
  </verify>
  <done>
    GameScreen calls submitScore silently on win. WinModal shows rank for non-anon users in top 50, "New personal best!" banner when applicable, and "View leaderboard" button opening LeaderboardModal overlay.
  </done>
</task>

<task type="auto">
  <name>Task 2: Real LeaderboardScreen + PuzzleSelectScreen leaderboard access</name>
  <files>
    src/screens/LeaderboardScreen/LeaderboardScreen.tsx
    src/screens/LeaderboardScreen/LeaderboardScreen.module.css
    src/screens/PuzzleSelectScreen/PuzzleSelectScreen.tsx
    src/screens/PuzzleSelectScreen/PuzzleTile.tsx
    src/screens/PuzzleSelectScreen/PuzzleTile.module.css
  </files>
  <action>
    MODIFY `src/screens/LeaderboardScreen/LeaderboardScreen.tsx`:

    Replace the Phase 3 stub with a real implementation. The LeaderboardScreen receives `puzzleId` and `difficulty` from route params (`/leaderboard/:difficulty/:puzzleId`). It should render the leaderboard for that puzzle directly (not as a modal â€” it's a full screen). Use `useLeaderboard(puzzleId)` for data. Layout:
    - Back button (navigate(-1))
    - Puzzle title: "Puzzle {N} Leaderboard" derived from puzzleId
    - The same leaderboard table as LeaderboardModal (reuse display logic, or inline for simplicity since it's a full-screen variant)
    - Loading skeleton, no-entries state, anonymous gate â€” same as LeaderboardModal
    - User row highlighting

    Note: Per CONTEXT.md, leaderboard from puzzle selection can be "modal or navigation â€” Claude decides". Decision: from PuzzleSelectScreen, use a MODAL (not navigation) for consistency with the win screen. The LeaderboardScreen route (`/leaderboard/:difficulty/:puzzleId`) still exists and works (accessible if someone navigates directly), but PuzzleSelectScreen will open the modal instead of navigating there.

    MODIFY `src/screens/PuzzleSelectScreen/PuzzleTile.tsx`:

    Add a small leaderboard icon button ("ðŸ†" or "â‰¡" or "â¬†" with label "Leaderboard") to each puzzle tile. This button:
    - Calls `onLeaderboard(puzzle.id)` prop callback (do not open modal inside PuzzleTile â€” let parent handle it)
    - `event.stopPropagation()` to prevent tile click (which navigates to play)
    - Styled as a small overlay button in the corner of the tile (e.g., top-right corner, small with opacity on hover)

    Add `onLeaderboard: (puzzleId: string) => void` to `PuzzleTileProps`.

    MODIFY `src/screens/PuzzleSelectScreen/PuzzleSelectScreen.tsx`:

    Add state: `leaderboardPuzzleId: string | null` (default null).

    Pass `onLeaderboard={(id) => setLeaderboardPuzzleId(id)}` to each PuzzleTile (via PuzzleGrid component â€” check if PuzzleGrid needs updating too; if so, add the prop chain).

    Render `{leaderboardPuzzleId && <LeaderboardModal puzzleId={leaderboardPuzzleId} onClose={() => setLeaderboardPuzzleId(null)} onSignInToCompete={...} />}` at the bottom of the screen.

    Check `src/screens/PuzzleSelectScreen/PuzzleGrid.tsx` â€” if PuzzleTile is rendered inside PuzzleGrid, add the `onLeaderboard` prop chain through PuzzleGrid as well.

    MODIFY `src/screens/PuzzleSelectScreen/PuzzleTile.module.css`:
    Add `.leaderboardBtn` style: absolute positioned in top-right corner of tile, small size (20-24px), transparent background, visible on hover/focus.
  </action>
  <verify>
    `npm run typecheck` passes.
    Inspect PuzzleTile.tsx: has `onLeaderboard` prop and a button calling it.
    Inspect PuzzleSelectScreen.tsx: has `leaderboardPuzzleId` state and renders `LeaderboardModal` when non-null.
    Inspect LeaderboardScreen.tsx: no longer shows "Coming in Phase 4", uses `useLeaderboard`.
  </verify>
  <done>
    LeaderboardScreen shows real data (no stub). PuzzleSelectScreen has per-tile leaderboard button opening LeaderboardModal. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
`npm run typecheck` â€” zero errors.
Inspect: `submitScore` called in GameScreen win useEffect.
Inspect: WinModal has `isNewPersonalBest` banner + rank display + LeaderboardModal overlay.
Inspect: LeaderboardScreen uses `useLeaderboard`.
Inspect: PuzzleTile has leaderboard button, PuzzleSelectScreen renders LeaderboardModal.
</verification>

<success_criteria>
- Score submitted silently on every puzzle win for non-anonymous users
- WinModal: rank shown for top-50 users, "New personal best!" when applicable, "View leaderboard" button opens LeaderboardModal
- LeaderboardScreen: real implementation (no stub text)
- PuzzleSelectScreen: per-puzzle leaderboard button opens LeaderboardModal
- REQ-047 fully satisfied: leaderboard accessible from both screens
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-firebase-integration/04-04-SUMMARY.md` with:
- What was modified and how
- Score submission wiring
- WinModal enhancements
- PuzzleTile leaderboard integration
- Any deviations from plan
</output>
