---
phase: 04-firebase-integration
plan: 05
type: execute
wave: 3
depends_on:
  - 04-02
  - 04-03
files_modified:
  - src/screens/ProfileScreen/ProfileScreen.tsx
  - src/screens/ProfileScreen/ProfileScreen.module.css
  - src/App.tsx
  - src/screens/MainMenuScreen/MainMenuScreen.tsx
  - src/screens/MainMenuScreen/MainMenuScreen.module.css
autonomous: true
requirements:
  - REQ-040
  - REQ-041

must_haves:
  truths:
    - "ProfileScreen shows the user's display name, allows editing it (uniqueness enforced), and has a Sign Out button"
    - "ProfileScreen shows a personal stats summary (total puzzles solved, best scores)"
    - "Display name edit validates length (2-20 chars), shows 'taken' feedback, shows 'saved' on success"
    - "Sign out returns the user to the AuthPromptScreen (auth gate blocks routing)"
    - "When an anonymous user tries to view the leaderboard, they see a prompt to sign in; clicking it calls the anonymous-to-Google upgrade flow"
    - "The upgrade flow handles both: happy path (linkWithPopup preserves UID) and conflict path (credential-already-in-use: merge scores, sign in as Google user)"
    - "After successful upgrade, anonymous user is now a Google user and can submit scores"
    - "MainMenuScreen has a visible route to ProfileScreen (profile icon or button)"
  artifacts:
    - path: "src/screens/ProfileScreen/ProfileScreen.tsx"
      provides: "Display name editing, sign out, personal stats summary"
      exports: ["ProfileScreen"]
    - path: "src/screens/ProfileScreen/ProfileScreen.module.css"
      provides: "Profile screen styles"
    - path: "src/App.tsx"
      provides: "Profile route added (/profile)"
      contains: "ProfileScreen"
    - path: "src/screens/MainMenuScreen/MainMenuScreen.tsx"
      provides: "Profile navigation link/button in header"
      contains: "profile"
    - path: "src/store/authStore.ts"
      provides: "upgradeAnonymousToGoogle action added to auth store"
      contains: "upgradeAnonymousToGoogle"
  key_links:
    - from: "src/screens/ProfileScreen/ProfileScreen.tsx"
      to: "src/services/scoreService.ts"
      via: "setDisplayName() called on form submit"
      pattern: "setDisplayName"
    - from: "src/store/authStore.ts"
      to: "firebase/auth"
      via: "linkWithPopup + signInWithCredential for upgrade; signOut for logout"
      pattern: "linkWithPopup|signOut"
    - from: "src/components/LeaderboardModal/LeaderboardModal.tsx"
      to: "src/store/authStore.ts"
      via: "onSignInToCompete prop calls authStore.upgradeAnonymousToGoogle"
      pattern: "upgradeAnonymousToGoogle"
---

<objective>
Build the ProfileScreen (display name editing, sign out, personal stats), add the anonymous-to-Google upgrade flow to the auth store, and wire the LeaderboardModal's sign-in gate to trigger the upgrade.

Purpose: Completes the full identity lifecycle: anonymous play → leaderboard motivation → upgrade to Google → compete. Also gives users control over their display name and account.

Output: ProfileScreen accessible from MainMenuScreen, `upgradeAnonymousToGoogle` in authStore wired to LeaderboardModal's anonymous gate, sign-out returning to AuthPromptScreen.
</objective>

<execution_context>
@C:/Users/omerb/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/omerb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/04-firebase-integration/04-CONTEXT.md
@.planning/phases/04-firebase-integration/04-RESEARCH.md
@src/store/authStore.ts
@src/App.tsx
@src/screens/MainMenuScreen/MainMenuScreen.tsx
@src/store/progressStore.ts
@src/data/puzzleIndex.ts
@.planning/phases/04-firebase-integration/04-02-SUMMARY.md
@.planning/phases/04-firebase-integration/04-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Anonymous-to-Google upgrade flow + sign out in authStore</name>
  <files>
    src/store/authStore.ts
  </files>
  <action>
    MODIFY `src/store/authStore.ts` to add `upgradeAnonymousToGoogle` and `signOut` actions.

    Add to `AuthStore` interface:
    ```typescript
    upgradeAnonymousToGoogle: () => Promise<'linked' | 'merged' | 'cancelled' | 'error'>;
    signOut: () => Promise<void>;
    upgradeStatus: 'idle' | 'upgrading' | 'success' | 'error';
    ```

    Add `upgradeStatus: 'idle'` to initial state.

    Implement `upgradeAnonymousToGoogle`:
    ```typescript
    upgradeAnonymousToGoogle: async () => {
      const currentUser = auth.currentUser;
      if (!currentUser || !currentUser.isAnonymous) return 'error';

      set({ upgradeStatus: 'upgrading' });

      try {
        // Happy path: link anonymous account to Google — UID preserved
        await linkWithPopup(currentUser, googleProvider);
        // Migrate any local anonymous scores to Firestore under same UID
        await mergeAnonymousScores(currentUser.uid, currentUser.uid); // same UID, just makes scores "official"
        set({ upgradeStatus: 'success' });
        return 'linked';
      } catch (err) {
        const error = err as AuthError;

        if (error.code === 'auth/popup-closed-by-user' || error.code === 'auth/cancelled-popup-request') {
          set({ upgradeStatus: 'idle' });
          return 'cancelled';
        }

        if (error.code === 'auth/credential-already-in-use') {
          // This Google account already has a Firebase identity.
          // Must: extract credential, sign in as Google user, merge anonymous scores
          try {
            const credential = (error as any).credential;
            const anonUid = currentUser.uid;
            const result = await signInWithCredential(auth, credential);
            // Merge anonymous scores from anonUid -> result.user.uid
            await mergeAnonymousScores(anonUid, result.user.uid);
            set({ upgradeStatus: 'success' });
            return 'merged';
          } catch {
            set({ upgradeStatus: 'error' });
            return 'error';
          }
        }

        set({ upgradeStatus: 'error' });
        return 'error';
      }
    },
    ```

    Import `linkWithPopup, signInWithCredential, signOut as firebaseSignOut, AuthError` from `'firebase/auth'`.
    Import `mergeAnonymousScores` from `'../services/scoreService'`.

    Note on linkWithPopup happy path: when `linkWithPopup` succeeds, the user's UID is preserved. The scores were stored locally (in progressStore, not Firestore — anonymous users don't submit to Firestore). So `mergeAnonymousScores(uid, uid)` is a no-op (same UID, no cross-user transfer needed). The key effect is: `user.isAnonymous` becomes `false` after linking, which unblocks score submission on future wins.

    Implement `signOut`:
    ```typescript
    signOut: async () => {
      await firebaseSignOut(auth);
      // onAuthStateChanged will fire with null, setting user: null
      // App.tsx gates on !user -> shows AuthPromptScreen
    },
    ```

    Wire `onSignInToCompete` in LeaderboardModal: update `src/components/LeaderboardModal/LeaderboardModal.tsx` to import `useAuthStore` and call `upgradeAnonymousToGoogle()` when the anonymous gate's sign-in button is clicked. Show loading state while `upgradeStatus === 'upgrading'`. On success, the `onAuthStateChanged` updates the store automatically, the modal re-renders with the real leaderboard. On error/cancelled, show a brief error message.
  </action>
  <verify>
    `npm run typecheck` passes.
    Inspect authStore.ts: `upgradeAnonymousToGoogle` handles three branches: happy path, popup-cancelled, credential-already-in-use.
    Inspect LeaderboardModal.tsx: `onSignInToCompete` calls `upgradeAnonymousToGoogle` (or it's wired internally).
  </verify>
  <done>
    `upgradeAnonymousToGoogle` handles all branches including credential-already-in-use with score merge. `signOut` wired. LeaderboardModal anonymous gate triggers upgrade. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: ProfileScreen + navigation link in MainMenuScreen + App route</name>
  <files>
    src/screens/ProfileScreen/ProfileScreen.tsx
    src/screens/ProfileScreen/ProfileScreen.module.css
    src/App.tsx
    src/screens/MainMenuScreen/MainMenuScreen.tsx
    src/screens/MainMenuScreen/MainMenuScreen.module.css
  </files>
  <action>
    Create `src/screens/ProfileScreen/ProfileScreen.tsx`. Per CONTEXT.md decisions, the profile section must contain:
    1. Display name editing (with uniqueness enforcement, length 2-20 chars)
    2. Sign out button
    3. Personal stats summary (total puzzles solved + best scores/rankings across puzzles — read from progressStore)

    Implementation:
    - Read `user` from `useAuthStore()`
    - Read `progress` from `useProgressStore()` for personal stats
    - `displayName` state: initialized from `user.displayName` or from Firestore `users/{uid}.displayName`
    - On mount: `getUserDisplayName(user.uid)` to load the stored display name
    - Edit form: text input (max 20 chars), "Save" button
    - On "Save": call `setDisplayName(newName)`, handle 'ok' | 'taken' | 'invalid' return:
      - 'ok': show "Saved!" feedback for 2s, update local displayName state
      - 'taken': show "Name already taken" error inline
      - 'invalid': show "Name must be 2-20 characters" error inline
    - Show anonymous user notice if `user.isAnonymous`: "You are playing anonymously. Sign in to edit your profile." with a "Sign in with Google" button calling `upgradeAnonymousToGoogle`.
    - Sign out button: calls `useAuthStore().signOut()`, after which auth gate redirects to AuthPromptScreen automatically
    - Personal stats summary (Claude's discretion on layout — use a simple card grid):
      - "Puzzles Solved: N" (count of keys in progress)
      - "Best overall: N moves" (minimum moves across all solved puzzles)
      - "Fastest time: M:SS" (minimum time across all solved puzzles)
      - Note: these are LOCAL stats from progressStore, not from Firestore leaderboards
    - Back button: navigate(-1)

    Create `src/screens/ProfileScreen/ProfileScreen.module.css`: match dark theme. Header with title "Profile" + back button. Sections with card styling. Display name form with inline error/success messaging.

    MODIFY `src/App.tsx`: add `<Route path="/profile" element={<ProfileScreen />} />` to the Routes list. Import `ProfileScreen`.

    MODIFY `src/screens/MainMenuScreen/MainMenuScreen.tsx`: add a profile navigation button/link in the top-right corner of the main menu. Use a small "Profile" text button or user icon button with ARIA label. Calls `navigate('/profile')`. Keep the existing layout (puzzle preview + title + play button) intact — the profile button should be an overlay or header element, not disruptive.

    MODIFY `src/screens/MainMenuScreen/MainMenuScreen.module.css`: add `.profileButton` style — absolute positioned top-right, small, muted styling.
  </action>
  <verify>
    `npm run typecheck` passes.
    Inspect App.tsx: `/profile` route exists.
    Inspect MainMenuScreen.tsx: profile navigation button exists.
    Inspect ProfileScreen.tsx: has display name form, sign out, stats summary, anonymous notice.
  </verify>
  <done>
    ProfileScreen accessible via MainMenuScreen navigation. Display name edit works with validation feedback. Sign out returns to AuthPromptScreen. Personal stats shown from progressStore. TypeScript compiles.
  </done>
</task>

</tasks>

<verification>
`npm run typecheck` — zero errors.
Inspect authStore: `upgradeAnonymousToGoogle` and `signOut` exist.
Inspect ProfileScreen: display name form, sign out, stats summary, anonymous notice.
Inspect App.tsx: `/profile` route.
Inspect MainMenuScreen: profile button.
</verification>

<success_criteria>
- `upgradeAnonymousToGoogle` handles happy path, user-cancelled, and credential-already-in-use (with score merge)
- LeaderboardModal anonymous gate triggers upgrade flow
- ProfileScreen: display name edit (uniqueness enforced), sign out, personal stats
- Sign out returns user to AuthPromptScreen
- `/profile` route in App.tsx, reachable from MainMenuScreen
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-firebase-integration/04-05-SUMMARY.md` with:
- Upgrade flow branches and how each is handled
- ProfileScreen feature list
- Any deviations from plan
</output>
