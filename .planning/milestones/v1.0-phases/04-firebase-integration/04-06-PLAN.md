---
phase: 04-firebase-integration
plan: 06
type: execute
wave: 4
depends_on:
  - 04-04
  - 04-05
files_modified: []
autonomous: false
requirements:
  - REQ-038
  - REQ-039
  - REQ-040
  - REQ-041
  - REQ-042
  - REQ-043
  - REQ-044
  - REQ-045
  - REQ-046
  - REQ-047
  - NFR-006

must_haves:
  truths:
    - "App launch shows auth prompt — user must choose Google or Anonymous before any game screen"
    - "Google sign-in popup works and returns user to the app signed in"
    - "Anonymous play works — main menu accessible, puzzles playable, leaderboard viewable but not submittable"
    - "Solving a puzzle submits the score silently; WinModal shows leaderboard rank for Google users"
    - "WinModal 'View leaderboard' opens the leaderboard modal overlay"
    - "PuzzleSelectScreen leaderboard buttons open leaderboard per puzzle"
    - "Profile screen accessible, display name editable, sign out works"
    - "Anonymous-to-Google upgrade works when triggered from leaderboard gate"
    - "Firestore rules deployed: anonymous writes rejected, non-improvements rejected, minMoves enforced"
  artifacts:
    - path: "firestore.rules"
      provides: "Deployed rules on Firebase project"
    - path: "src/screens/AuthPromptScreen/AuthPromptScreen.tsx"
      provides: "Functional blocking auth prompt"
    - path: "src/components/LeaderboardModal/LeaderboardModal.tsx"
      provides: "Functional leaderboard modal"
    - path: "src/screens/ProfileScreen/ProfileScreen.tsx"
      provides: "Functional profile screen"
  key_links: []
---

<objective>
Human verification of the complete Phase 4 Firebase integration. Covers auth flows, score submission, leaderboard display, profile management, and Firestore security rules deployment.

Purpose: End-to-end verification that all user-facing behaviors work as specified in CONTEXT.md and that server-side rules are deployed and enforcing data integrity.

Output: Phase 4 verified complete or gaps identified for fix.
</objective>

<execution_context>
@C:/Users/omerb/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/omerb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/04-firebase-integration/04-CONTEXT.md
@.planning/ROADMAP.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Deploy Firestore security rules and index</name>
  <action>Deploy `firestore.rules` and `firestore.indexes.json` to the Firebase project via firebase-tools CLI or manually via the Firebase Console Rules and Indexes tabs.</action>
  <what-built>
    Firestore security rules (`firestore.rules`) and composite index (`firestore.indexes.json`) were written in plan 04-02. They need to be deployed to the Firebase project before the leaderboard and score submission can work correctly.
  </what-built>
  <how-to-verify>
    Option A — firebase-tools CLI (recommended if installed):
    ```bash
    npx firebase-tools login   # if not already authenticated
    npx firebase-tools use --add  # select your Firebase project
    npx firebase-tools deploy --only firestore
    ```

    Option B — Manual via Firebase Console:
    1. Go to Firestore -> Rules tab, paste the content of `firestore.rules`, click "Publish"
    2. Go to Firestore -> Indexes tab, click "Add index", fill in:
       - Collection: `scores`
       - Field 1: `moves` Ascending
       - Field 2: `timeMs` Ascending
       - Click "Create"

    Confirm:
    - Rules show "Published" in the Rules tab
    - Index shows "Building" or "Enabled" in the Indexes tab (building takes 1-2 min for new collections)
  </how-to-verify>
  <resume-signal>Type "rules deployed" when Firestore rules and index are published, or describe issues</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete Phase 4 auth and leaderboard flows</name>
  <action>Human verifies all auth and leaderboard flows end-to-end: auth prompt, Google sign-in, anonymous play, score submission, WinModal rank display, LeaderboardModal from win and puzzle selection, profile screen, and anonymous-to-Google upgrade flow.</action>
  <what-built>
    Full Firebase integration: auth prompt at launch, Google/anonymous sign-in, score submission on win, leaderboard modal from win screen and puzzle selection, profile screen with display name editing, anonymous-to-Google upgrade flow, sign out.
  </what-built>
  <how-to-verify>
    Run `npm run dev` and open the app in the browser. Complete each flow:

    **Auth flow:**
    1. Clear localStorage/cookies for the app origin (DevTools -> Application -> Storage -> Clear site data)
    2. Reload the app — auth prompt should appear immediately (no main menu flash)
    3. Click "Play anonymously" — main menu should appear
    4. Reload — app should go directly to main menu (anonymous session persists)

    **Google sign-in:**
    5. Sign out via Profile screen -> sign out button — auth prompt should appear
    6. Click "Sign in with Google" — Google popup should open, sign in, app shows main menu with your Google account name available in Profile

    **Score submission + leaderboard from win screen:**
    7. Play any puzzle as a Google user and win it
    8. WinModal should appear with "View leaderboard" button
    9. If this is your first solve: check no rank is shown yet (or #1 if you're first on this puzzle)
    10. Click "View leaderboard" — LeaderboardModal opens as overlay on top of WinModal
    11. Your name should appear highlighted in the list
    12. Close the modal, close WinModal, solve the same puzzle again faster — WinModal should show "New personal best!" banner

    **Leaderboard from puzzle selection:**
    13. Go to puzzle selection screen, hover over any puzzle tile
    14. A small leaderboard button (trophy icon or similar) should appear — click it
    15. LeaderboardModal should open for that puzzle

    **Profile screen:**
    16. From main menu, navigate to Profile
    17. Edit display name to something unique — "Save" should show "Saved!"
    18. Try an already-taken name (if any other test user exists) — should show "Name already taken"
    19. Sign out — returns to auth prompt

    **Anonymous-to-Google upgrade:**
    20. Sign in as anonymous (sign out first, then choose "Play anonymously")
    21. Navigate to puzzle selection, click the leaderboard button on any puzzle
    22. LeaderboardModal should show anonymous gate: "Sign in to compete" button
    23. Click "Sign in to compete" — upgrade flow should trigger (Google popup)
    24. After linking, should now be a Google user — leaderboard shows your data
    25. Leaderboard table should still be visible even before upgrading (can read, can't write)

    **Security rules (manual test):**
    26. In Firebase Console -> Firestore -> Data, verify no anonymous user scores appear in puzzles/{id}/scores/
    27. Rules Playground (Firestore -> Rules -> Rules playground): simulate a write with isAnonymous=true — should be rejected

    Report any issues found. Mark "approved" if everything works as expected.
  </how-to-verify>
  <resume-signal>Type "approved" if all flows work correctly, or describe specific issues found (e.g., "rank not showing", "upgrade flow fails")</resume-signal>
</task>

</tasks>

<verification>
Complete Phase 4 verification:
- All 5 auth/leaderboard user flows verified by human
- Firestore rules deployed and enforcing data integrity
- `npm run build` passes (no build errors from Firebase integration)
- TypeScript: `npm run typecheck` — zero errors
</verification>

<success_criteria>
- Auth prompt blocks app until user chooses identity
- Google and anonymous sign-in both work
- Score submitted silently on win, WinModal shows rank and personal best callout
- LeaderboardModal accessible from both win screen and puzzle selection
- Profile screen: display name edit (uniqueness enforced), sign out
- Anonymous-to-Google upgrade triggered from leaderboard gate works
- Firestore rules deployed and rejecting invalid writes
- Phase 4 all requirements verified: REQ-038 through REQ-047, NFR-006
</success_criteria>

<output>
After completion, create `.planning/phases/04-firebase-integration/04-06-SUMMARY.md` with:
- Verification results for each flow
- Any issues found and whether they were fixed
- Confirmation that Firestore rules are deployed
- Phase 4 completion status
</output>
