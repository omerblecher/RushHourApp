---
phase: 05-sound-and-polish
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/soundService.ts
  - src/components/GameHeader/GameHeader.tsx
  - src/components/GameHeader/GameHeader.module.css
  - src/components/HelpModal/HelpModal.tsx
  - src/components/HelpModal/HelpModal.module.css
  - src/components/AboutModal/AboutModal.tsx
  - src/components/AboutModal/AboutModal.module.css
  - public/sounds/slide.mp3
  - public/sounds/win.mp3
  - public/sounds/level-start.mp3
  - package.json
autonomous: true
requirements:
  - REQ-033
  - REQ-034
  - REQ-035
  - REQ-036
  - REQ-037
  - NFR-002
  - NFR-003

must_haves:
  truths:
    - "soundService singleton is importable and exposes playSlide, playWin, playStart, setMuted, isMuted, playUnmuteChime"
    - "Global mute state reads rushhour_muted from localStorage on init and applies Howler.mute() immediately"
    - "GameHeader renders mute toggle, help button, and about button in the game top bar"
    - "HelpModal opens with how-to-play text instructions and closes on backdrop or button click"
    - "AboutModal opens with credits text and closes on backdrop or button click"
    - "Sound files exist in public/sounds/ directory and Howl instances reference them correctly"
  artifacts:
    - path: "src/services/soundService.ts"
      provides: "Howler.js singleton for all audio"
      exports: ["soundService"]
    - path: "src/components/GameHeader/GameHeader.tsx"
      provides: "Game header bar with mute, help, about buttons"
      exports: ["GameHeader"]
    - path: "src/components/HelpModal/HelpModal.tsx"
      provides: "How-to-play modal with text instructions"
      exports: ["HelpModal"]
    - path: "src/components/AboutModal/AboutModal.tsx"
      provides: "Credits modal"
      exports: ["AboutModal"]
    - path: "public/sounds/slide.mp3"
      provides: "Car slide sound asset"
    - path: "public/sounds/win.mp3"
      provides: "Win celebration sound asset"
    - path: "public/sounds/level-start.mp3"
      provides: "Level start sound asset"
  key_links:
    - from: "src/services/soundService.ts"
      to: "public/sounds/*.mp3"
      via: "Howl src: ['/sounds/xxx.mp3']"
      pattern: "src.*sounds/"
    - from: "src/services/soundService.ts"
      to: "Howler global"
      via: "Howler.mute(savedMuted) on module init"
      pattern: "Howler\\.mute"
    - from: "src/components/GameHeader/GameHeader.tsx"
      to: "src/services/soundService.ts"
      via: "soundService.setMuted() + soundService.isMuted()"
      pattern: "soundService\\.(setMuted|isMuted)"
---

<objective>
Install Howler.js + canvas-confetti, source 3 open-license sound files, create the soundService singleton, and build the GameHeader with Help and About modals.

Purpose: Establish the audio foundation and header UI that all subsequent plans depend on. The soundService must be importable from any file without React lifecycle coupling. GameHeader brings mute control to the top bar per the user decision.

Output: soundService.ts (singleton), GameHeader + HelpModal + AboutModal components, 3 MP3 sound files in public/sounds/.
</objective>

<execution_context>
@C:/Users/omerb/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/omerb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-sound-and-polish/05-CONTEXT.md
@.planning/phases/05-sound-and-polish/05-RESEARCH.md
@src/components/ControlBar/ControlBar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and source sound files</name>
  <files>package.json, public/sounds/slide.mp3, public/sounds/win.mp3, public/sounds/level-start.mp3</files>
  <action>
Install howler, @types/howler, canvas-confetti, and @types/canvas-confetti:
```
npm install howler canvas-confetti
npm install --save-dev @types/howler @types/canvas-confetti
```

Then source 3 open-license MP3 sound files with light, playful, bouncy character (not mechanical or minimal). Download from Freesound.org (account not required for browsing; use Creative Commons 0 or Attribution licenses). Target files:

1. slide.mp3 â€” short (~0.3-0.5s), soft "whoosh" or "swoosh" sound appropriate for a sliding vehicle on a board. Search Freesound: "slide whoosh short" or "wood slide". Good candidates: any brief friction/slide sound without reverb tails.

2. win.mp3 â€” celebratory, bright, ~1-2 seconds. Search Freesound: "win chime" or "success jingle" or "puzzle complete". Should feel rewarding, not triumphant/bombastic.

3. level-start.mp3 â€” short (~0.5-1s) neutral/positive "ready" or "pop" sound. Search Freesound: "level start" or "ready pop" or "notification chime". Should feel like "puzzle loaded, let's go."

Download each file and save as:
- public/sounds/slide.mp3
- public/sounds/win.mp3
- public/sounds/level-start.mp3

If Freesound requires login for specific files, try alternative: pixabay.com/sound-effects/ (no account required for download, Royalty Free license). Search same terms. Pick files that match the "light and playful" character per user decision.

Verify: All 3 files exist and are valid MP3s (non-zero file size, not HTML error pages).
  </action>
  <verify>
Run: `npm list howler canvas-confetti` â€” should show installed versions.
Run: `ls public/sounds/` â€” should show slide.mp3, win.mp3, level-start.mp3.
Run: `stat public/sounds/slide.mp3 public/sounds/win.mp3 public/sounds/level-start.mp3` â€” all files > 1000 bytes.
  </verify>
  <done>howler and canvas-confetti appear in node_modules. All 3 MP3 files exist in public/sounds/ with non-trivial file size (at least 1KB each).</done>
</task>

<task type="auto">
  <name>Task 2: Create soundService singleton</name>
  <files>src/services/soundService.ts</files>
  <action>
Create `src/services/soundService.ts` as a module-level singleton. Howl instances are created ONCE at module load (not inside React components or hooks â€” creating them repeatedly causes memory leaks and breaks audio context limits).

```typescript
import { Howl, Howler } from 'howler';

const MUTE_KEY = 'rushhour_muted';

// Create Howl instances once at module load
const slideSound = new Howl({
  src: ['/sounds/slide.mp3'],
  volume: 0.6,
  preload: true,
});

const winSound = new Howl({
  src: ['/sounds/win.mp3'],
  volume: 0.8,
  preload: true,
});

const startSound = new Howl({
  src: ['/sounds/level-start.mp3'],
  volume: 0.7,
  preload: true,
});

// Apply persisted mute state immediately on module load
// Howler.mute(true) silences ALL Howl instances globally
const savedMuted = localStorage.getItem(MUTE_KEY) === 'true';
Howler.mute(savedMuted);

export const soundService = {
  playSlide: () => slideSound.play(),
  playWin: () => winSound.play(),
  playStart: () => startSound.play(),

  setMuted: (muted: boolean) => {
    Howler.mute(muted);
    localStorage.setItem(MUTE_KEY, String(muted));
  },

  isMuted: (): boolean => localStorage.getItem(MUTE_KEY) === 'true',

  // Play a soft chime on unmute to confirm audio is restored (user decision)
  // Reuses startSound as the chime â€” short and appropriate
  playUnmuteChime: () => startSound.play(),
};
```

Key facts:
- Import from 'howler' works with Vite's CJS pre-bundling + @types/howler 2.2.12 â€” no special vite.config changes needed.
- Use `Howler.mute()` (not `Howler.volume(0)`) â€” mute preserves volume setting, correct API.
- `autoUnlock: true` is the Howler default â€” no manual gesture unlock code needed.
- The `playUnmuteChime` reuses startSound for simplicity; both are short and appropriate as a confirmation chime.
  </action>
  <verify>
Run: `npx tsc --noEmit` â€” zero TypeScript errors in soundService.ts.
Check: `src/services/soundService.ts` exports `soundService` object with all 5 methods.
  </verify>
  <done>soundService.ts compiles without TypeScript errors. Exports soundService with playSlide, playWin, playStart, setMuted, isMuted, playUnmuteChime methods. Howler.mute() is called on module load with the persisted value.</done>
</task>

<task type="auto">
  <name>Task 3: Create GameHeader, HelpModal, and AboutModal components</name>
  <files>
    src/components/GameHeader/GameHeader.tsx
    src/components/GameHeader/GameHeader.module.css
    src/components/HelpModal/HelpModal.tsx
    src/components/HelpModal/HelpModal.module.css
    src/components/AboutModal/AboutModal.tsx
    src/components/AboutModal/AboutModal.module.css
  </files>
  <action>
Create GameHeader with mute toggle + help button + about button. Layout: horizontal bar with three icon buttons. User decision: mute icon is speaker-with-waves (unmuted) or speaker-with-X (muted). Help and About are text icon buttons (? and i). Exact spacing/layout at Claude's discretion.

**GameHeader.tsx:**
```typescript
import { useState } from 'react';
import { soundService } from '../../services/soundService';
import { HelpModal } from '../HelpModal/HelpModal';
import { AboutModal } from '../AboutModal/AboutModal';
import styles from './GameHeader.module.css';

export function GameHeader() {
  const [isMuted, setIsMuted] = useState<boolean>(soundService.isMuted());
  const [showHelp, setShowHelp] = useState(false);
  const [showAbout, setShowAbout] = useState(false);

  const handleMuteToggle = () => {
    const next = !isMuted;
    soundService.setMuted(next);
    if (!next) soundService.playUnmuteChime(); // confirm audio on unmute
    setIsMuted(next);
  };

  return (
    <header className={styles.header} role="banner">
      <button
        className={styles.iconButton}
        onClick={handleMuteToggle}
        aria-label={isMuted ? 'Unmute sound' : 'Mute sound'}
        aria-pressed={isMuted}
        title={isMuted ? 'Unmute sound' : 'Mute sound'}
      >
        {/* Standard speaker iconography per user decision */}
        {isMuted ? 'ðŸ”‡' : 'ðŸ”Š'}
      </button>

      <button
        className={styles.iconButton}
        onClick={() => setShowHelp(true)}
        aria-label="How to play"
        title="How to play"
      >
        ?
      </button>

      <button
        className={styles.iconButton}
        onClick={() => setShowAbout(true)}
        aria-label="About"
        title="About"
      >
        i
      </button>

      {showHelp && <HelpModal onClose={() => setShowHelp(false)} />}
      {showAbout && <AboutModal onClose={() => setShowAbout(false)} />}
    </header>
  );
}
```

**GameHeader.module.css:**
Style the header as a compact horizontal bar above the game. Buttons are round icon buttons with hover state. Exact sizing at Claude's discretion â€” keep it compact so it doesn't crowd the board.

```css
.header {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 8px;
  width: 100%;
  padding: 4px 0 8px;
}

.iconButton {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 2px solid rgba(255, 255, 255, 0.25);
  background: rgba(255, 255, 255, 0.12);
  color: #fff;
  font-size: 16px;
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s;
}

.iconButton:hover {
  background: rgba(255, 255, 255, 0.22);
  border-color: rgba(255, 255, 255, 0.45);
}

.iconButton:focus-visible {
  outline: 2px solid #f5c842;
  outline-offset: 2px;
}
```

**HelpModal.tsx:**
Text-only how-to-play modal (user decision: text instructions only, no diagrams or animations). Closes on backdrop click or Close button.

```typescript
import styles from './HelpModal.module.css';

interface HelpModalProps {
  onClose: () => void;
}

export function HelpModal({ onClose }: HelpModalProps) {
  return (
    <div className={styles.backdrop} onClick={onClose} role="dialog" aria-modal="true" aria-label="How to play">
      <div className={styles.modal} onClick={(e) => e.stopPropagation()}>
        <h2 className={styles.title}>How to Play</h2>
        <div className={styles.body}>
          <p>Slide vehicles to clear a path for the <strong>red car</strong> to reach the exit on the right side of the board.</p>
          <ul>
            <li>Drag vehicles left/right or up/down along their axis.</li>
            <li>Vehicles cannot pass through each other.</li>
            <li>Free the red car to win!</li>
            <li>Fewer moves = better score.</li>
          </ul>
          <p><strong>Controls:</strong></p>
          <ul>
            <li><strong>Mouse/Touch:</strong> Drag vehicles directly.</li>
            <li><strong>Keyboard:</strong> Tab to select a vehicle, Arrow Keys to move, Escape to deselect.</li>
          </ul>
        </div>
        <button className={styles.closeButton} onClick={onClose} autoFocus>
          Got it!
        </button>
      </div>
    </div>
  );
}
```

**HelpModal.module.css:** Style as centered overlay modal with semi-transparent backdrop. Dark modal card matching the game's aesthetic.

**AboutModal.tsx:**
Credits modal per user decision (who built it and tools used, no links or version number).

```typescript
import styles from './AboutModal.module.css';

interface AboutModalProps {
  onClose: () => void;
}

export function AboutModal({ onClose }: AboutModalProps) {
  return (
    <div className={styles.backdrop} onClick={onClose} role="dialog" aria-modal="true" aria-label="About">
      <div className={styles.modal} onClick={(e) => e.stopPropagation()}>
        <h2 className={styles.title}>About</h2>
        <div className={styles.body}>
          <p>Rush Hour Puzzle Game</p>
          <p>Built with React, TypeScript, Vite, Zustand, and Firebase.</p>
          <p>Sound effects from Freesound.org.</p>
          <p>Puzzle logic inspired by the classic Rush Hour board game by ThinkFun.</p>
        </div>
        <button className={styles.closeButton} onClick={onClose} autoFocus>
          Close
        </button>
      </div>
    </div>
  );
}
```

**AboutModal.module.css:** Use same pattern as HelpModal.module.css. Reuse the modal style â€” DRY CSS via shared class names in each module file (same values, separate module files).

For both modal CSS files:
```css
.backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 200;
}

.modal {
  background: #2a1f16;
  border-radius: 16px;
  padding: 24px;
  max-width: 380px;
  width: 90%;
  box-shadow: 0 16px 48px rgba(0, 0, 0, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.1);
  color: #f5f0e8;
}

.title {
  font-size: 1.3rem;
  font-weight: 700;
  margin: 0 0 16px;
  color: #f5c842;
}

.body {
  font-size: 0.95rem;
  line-height: 1.6;
  margin-bottom: 20px;
}

.body ul {
  padding-left: 20px;
  margin: 8px 0;
}

.body li {
  margin-bottom: 4px;
}

.closeButton {
  width: 100%;
  padding: 10px;
  background: #4a3728;
  color: #f5f0e8;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  font-size: 1rem;
  cursor: pointer;
  transition: background 0.15s;
}

.closeButton:hover {
  background: #5a4738;
}
```
  </action>
  <verify>
Run: `npx tsc --noEmit` â€” zero TypeScript errors in GameHeader, HelpModal, AboutModal.
Run: `npm run build` â€” builds successfully with no errors.
Verify: All 6 files exist (TSX + CSS module for each component).
  </verify>
  <done>GameHeader, HelpModal, and AboutModal components compile without TypeScript errors and the production build succeeds. GameHeader exports GameHeader, HelpModal exports HelpModal, AboutModal exports AboutModal.</done>
</task>

</tasks>

<verification>
1. Run `npm list howler canvas-confetti @types/howler @types/canvas-confetti` â€” all 4 packages present.
2. Run `npx tsc --noEmit` â€” zero TypeScript errors.
3. Run `npm run build` â€” build succeeds (vite output, no errors).
4. Check `public/sounds/` â€” slide.mp3, win.mp3, level-start.mp3 all present and > 1KB.
5. Check `src/services/soundService.ts` â€” exports soundService with 6 methods.
6. Check `src/components/GameHeader/GameHeader.tsx` â€” exports GameHeader.
</verification>

<success_criteria>
- howler, canvas-confetti (and @types) installed in node_modules
- 3 MP3 sound files in public/sounds/ with valid file sizes
- soundService.ts singleton compiles and applies Howler.mute() from localStorage on load
- GameHeader renders mute toggle, help, and about buttons
- HelpModal shows how-to-play text, closes on backdrop/button click
- AboutModal shows credits text, closes on backdrop/button click
- `npm run build` succeeds with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-sound-and-polish/05-01-SUMMARY.md`
</output>
